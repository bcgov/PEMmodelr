---
title: "03_run_final_model"
author: "G. Perkins"
date: "2023-04-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Run the final model 

```{r cars}
# set up the standard inputs 

fid <- setup_folders("CanyonCreek")

in_dir <- fid$model_inputs0310[2]

fmat <- read.csv(file.path(fid$AOI_dir[2], "fuzzy_matrix_basic.csv" ))%>%
  dplyr::select(target, Pred, fVal)

# set up tuning (applies to all models)
best_tune <- fread(file.path (in_dir, "best_tuning.csv"))
mtry <- best_tune$mtry
min_n <- best_tune$min_n

# select reduced variables
reduced_vars <- read.csv(file.path(in_dir,  "reduced_covariate_list.csv")) %>% pull()

bgc_pts_subzone <- readRDS(file.path(fid$model_inputs0310[2], "model_input_pts.rds"))

```

```{r}

model_bgc <- lapply(names(bgc_pts_subzone), function(xx) {
  
  xx <- names(bgc_pts_subzone[1])
  
  alldat = bgc_pts_subzone[[xx]]

  outDir = file.path(fid$model_final[2], xx)
 
  final_data <- alldat %>%
    dplyr::filter(position == "Orig") %>%
    dplyr::select(mapunit1, any_of(reduced_vars))
  
  final_data <-  final_data[complete.cases(tdat[, 2:length(final_data)]), ]

  # testing 
  final_data = as.data.table(final_data)
  final_data <-  final_data[grep("ICHmc2_", mapunit1), ]
  # end testing 
  
  final_model <- run_final_model(
      train_data,
      fuzz_matrix = fmat,
      mtry = 14, #mtry
      min_n = 7, #min_n
      ds_ratio = NULL, 
      sm_ratio = NULL)
  
  # Output model 
saveRDS(final_model, file.path(outDir, "final_model.rds"))

}


```
